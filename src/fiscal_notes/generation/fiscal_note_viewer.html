<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiscal Note Viewer with Chunk Attribution</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f7;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .file-selector {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .file-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }
        
        .file-selector input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 6px;
            background: #fafafa;
        }
        
        .fiscal-note-container {
            display: none;
        }
        
        .fiscal-note-header {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .document-title {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .generation-info {
            color: #666;
            font-size: 0.9em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            font-size: 0.8em;
            opacity: 0.9;
        }
        
        .fiscal-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        
        .section-title {
            color: #333;
            margin: 0 0 15px 0;
            font-size: 1.4em;
            text-transform: capitalize;
            font-weight: 600;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        
        .section-content {
            color: #444;
            line-height: 1.7;
            font-size: 1.05em;
        }
        
        .chunk-citation {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            border: 1px solid #ffc107;
            transition: all 0.2s ease;
        }
        
        .chunk-citation:hover {
            background: linear-gradient(135deg, #ffc107 0%, #f39c12 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        }
        
        .chunk-citation.with-amount {
            background: linear-gradient(135deg, #d4edda 0%, #a3d977 100%);
            color: #155724;
            border-color: #28a745;
        }
        
        .chunk-citation.with-amount:hover {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }
        
        .tooltip {
            position: absolute;
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.85em;
            z-index: 1000;
            max-width: 400px;
            min-width: 300px;
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border: 1px solid #34495e;
        }
        
        .tooltip::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid #2c3e50;
        }
        
        .tooltip-header {
            font-weight: bold;
            color: #3498db;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .tooltip-document {
            color: #e74c3c;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .tooltip-amount {
            color: #27ae60;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .tooltip-content {
            color: #ecf0f1;
            font-style: italic;
            line-height: 1.4;
            background: rgba(52, 73, 94, 0.3);
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #f44336;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
        
        .chunk-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 3px solid #6c757d;
        }
        
        .chunk-summary h3 {
            margin-top: 0;
            color: #495057;
        }
        
        .chunk-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .chunk-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        .chunk-id {
            font-weight: bold;
            color: #007bff;
        }
        
        .chunk-doc {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .section-chunks {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
        
        .chunks-title {
            color: #495057;
            margin: 0 0 15px 0;
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .chunks-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .chunk-reference {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #007bff;
        }
        
        .chunk-ref-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .chunk-ref-id {
            font-weight: bold;
            color: #007bff;
            font-size: 1.1em;
        }
        
        .chunk-ref-doc {
            color: #6c757d;
            font-size: 0.9em;
            font-weight: 500;
        }
        
        .chunk-ref-content {
            color: #495057;
            line-height: 1.5;
            font-size: 0.95em;
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .sentence-attribution {
            padding: 2px 4px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 0 1px;
        }
        
        .sentence-attribution.number-based {
            background: linear-gradient(135deg, #d4edda 0%, #a3d977 100%);
            border: 1px solid #28a745;
            color: #155724;
        }
        
        .sentence-attribution.number-based:hover {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }
        
        .sentence-attribution.word-frequency {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffc107;
            color: #856404;
        }
        
        .sentence-attribution.word-frequency:hover {
            background: linear-gradient(135deg, #ffc107 0%, #f39c12 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        }
        
        .sentence-attribution.no-attribution {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 1px solid #dc3545;
            color: #721c24;
        }
        
        .sentence-attribution.no-attribution:hover {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }
        
        .attribution-breakdown {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #6c757d;
        }
        
        .method-stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .method-stat {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .method-name {
            font-weight: 600;
            min-width: 150px;
        }
        
        .method-count {
            color: #495057;
        }
        
        .method-percent {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .section-attribution-summary {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
        
        .attribution-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 15px 0;
        }
        
        .attribution-stats .stat {
            background: #e9ecef;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            color: #495057;
            font-weight: 500;
        }
        
        .chunk-usage-count {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .chunk-methods {
            margin: 8px 0;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .method-tag {
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: capitalize;
        }
        
        .method-tag.number_based {
            background: #d4edda;
            color: #155724;
        }
        
        .method-tag.word_frequency_based {
            background: #fff3cd;
            color: #856404;
        }
        
        .method-tag.no_attribution {
            background: #f8d7da;
            color: #721c24;
        }
        
        .tooltip-method {
            color: #3498db;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .tooltip-chunk {
            color: #e74c3c;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .tooltip-reason {
            color: #f39c12;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .citation-number {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 2px 6px;
            margin: 0 2px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        
        .citation-number:hover {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
        }
        
        .citation-tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.85em;
            max-width: 400px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
        }
        
        .citation-tooltip-header {
            font-weight: 600;
            color: #4CAF50;
            margin-bottom: 6px;
        }
        
        .citation-tooltip-method {
            color: #FFC107;
            margin-bottom: 4px;
        }
        
        .citation-tooltip-content {
            color: #E0E0E0;
            line-height: 1.4;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>📋 Fiscal Note Viewer</h1>
        <p>Interactive viewer with chunk attribution tooltips</p>
    </div>

    <div class="file-selector">
        <label for="fiscalNoteInput">Select a fiscal note JSON file:</label>
        <input type="file" id="fiscalNoteInput" accept=".json" />
        <br><br>
        <label for="metadataInput">Select the corresponding metadata JSON file:</label>
        <input type="file" id="metadataInput" accept=".json" />
    </div>

    <div id="fiscalNoteContainer" class="fiscal-note-container">
        <!-- Content will be populated by JavaScript -->
    </div>

    <script>
        let fiscalNoteData = null;
        let metadataData = null;
        let chunkMap = new Map();
        let numbersMap = new Map();

        document.getElementById('fiscalNoteInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        fiscalNoteData = JSON.parse(e.target.result);
                        checkAndRender();
                    } catch (error) {
                        showError('Invalid fiscal note JSON file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        document.getElementById('metadataInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                loadMetadata();
            }
        });

        function loadMetadata() {
            const file = document.getElementById('metadataInput').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    metadataData = JSON.parse(e.target.result);
                    
                    // Create chunk map for easy lookup
                    chunkMap = new Map();
                    if (metadataData.response_metadata?.chunks_metadata?.chunk_details) {
                        metadataData.response_metadata.chunks_metadata.chunk_details.forEach(chunk => {
                            chunkMap.set(chunk.chunk_id, chunk);
                        });
                    }
                    
                    // Create numbers map for NUMBER_ IDs
                    numbersMap = new Map();
                    const numbersData = metadataData.response_metadata?.numbers_data;
                    if (numbersData && numbersData.length > 0) {
                        numbersData.forEach(numberItem => {
                            // Create keys in multiple formats to handle all variations
                            const baseNumber = numberItem.number;
                            const numberVariations = [
                                `NUMBER_${baseNumber}`,
                                `NUMBER_${baseNumber.toString()}`,
                                `NUMBER_${Math.floor(baseNumber)}`,
                                `NUMBER_${Math.floor(baseNumber)}.0`,
                                `NUMBER_${baseNumber.toFixed(1)}`,
                                `NUMBER_${baseNumber.toFixed(0)}`
                            ];
                            
                            const entryData = {
                                chunk_id: `NUMBER_${baseNumber}`,
                                document_name: numberItem.filename,
                                chunk_text: numberItem.text,
                                number: numberItem.number
                            };
                            
                            // Add all variations to the map
                            numberVariations.forEach(variation => {
                                numbersMap.set(variation, entryData);
                            });
                        });
                        console.log(`Loaded ${numbersData.length} number entries into numbersMap`);
                        console.log('Sample entries:', Array.from(numbersMap.keys()).slice(0, 6));
                        console.log('Sample number data:', numbersData.slice(0, 2));
                        
                        // Test specific lookup
                        const testLookup = numbersMap.get('NUMBER_557000');
                        if (testLookup) {
                            console.log('Found NUMBER_557000:', testLookup.document_name);
                        } else {
                            console.log('NUMBER_557000 not found, checking NUMBER_557000.0');
                            const testLookup2 = numbersMap.get('NUMBER_557000.0');
                            console.log('NUMBER_557000.0 result:', testLookup2 ? testLookup2.document_name : 'Not found');
                        }
                    } else {
                        console.log('No numbers_data found in metadata.response_metadata');
                        console.log('Available metadata keys:', Object.keys(metadataData.response_metadata || {}));
                        if (metadataData.response_metadata?.numbers_data) {
                            console.log('numbers_data exists but is empty:', metadataData.response_metadata.numbers_data);
                        }
                    }
                    
                    checkAndRender();
                } catch (error) {
                    showError('Error parsing metadata JSON: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function checkAndRender() {
            if (fiscalNoteData && metadataData) {
                displayFiscalNote();
            }
        }

        function displayFiscalNote() {
            const container = document.getElementById('fiscalNoteContainer');
            container.style.display = 'block';
            
            const attribution = metadataData.response_metadata?.sentence_attribution_analysis;
            const chunks = metadataData.response_metadata?.chunks_metadata;
            
            container.innerHTML = `
                ${generateHeader()}
                ${generateStats(attribution, chunks)}
                ${generateChunkSummary(chunks)}
                ${generateFiscalNoteSections()}
            `;

            // Add event listeners for citation numbers
            addCitationListeners();
        }

        function generateHeader() {
            return `
                <div class="fiscal-note-header">
                    <div class="document-title">${metadataData.document_name || 'Fiscal Note'}</div>
                    <div class="generation-info">
                        Generated: ${new Date(metadataData.generation_timestamp).toLocaleString()}<br>
                        Processed Documents: ${metadataData.processed_documents?.join(', ') || 'N/A'}
                    </div>
                </div>
            `;
        }

        function generateStats(attribution, chunks) {
            if (!attribution) return '';
            
            const totalSentences = attribution.sentence_attributions?.length || 0;
            const methodStats = attribution.attribution_method_stats || {};
            const chunkStats = attribution.chunk_usage_stats || {};
            const usedChunks = Object.values(chunkStats).filter(chunk => chunk.usage_count > 0).length;
            
            return `
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-number">${totalSentences}</span>
                        <span class="stat-label">Total Sentences</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${methodStats.number_based || 0}</span>
                        <span class="stat-label">Number-Based Attribution</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${methodStats.word_frequency_based || 0}</span>
                        <span class="stat-label">Word Frequency Attribution</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${usedChunks}/${chunks?.total_chunks || 0}</span>
                        <span class="stat-label">Chunks Used</span>
                    </div>
                </div>
                
                <div class="attribution-breakdown">
                    <h3>📊 Attribution Method Breakdown</h3>
                    <div class="method-stats">
                        <div class="method-stat">
                            <span class="method-name">🔢 Number-based:</span>
                            <span class="method-count">${methodStats.number_based || 0} sentences</span>
                            <span class="method-percent">(${totalSentences > 0 ? ((methodStats.number_based || 0) / totalSentences * 100).toFixed(1) : 0}%)</span>
                        </div>
                        <div class="method-stat">
                            <span class="method-name">📝 Word frequency:</span>
                            <span class="method-count">${methodStats.word_frequency_based || 0} sentences</span>
                            <span class="method-percent">(${totalSentences > 0 ? ((methodStats.word_frequency_based || 0) / totalSentences * 100).toFixed(1) : 0}%)</span>
                        </div>
                        <div class="method-stat">
                            <span class="method-name">❌ No attribution:</span>
                            <span class="method-count">${methodStats.no_attribution || 0} sentences</span>
                            <span class="method-percent">(${totalSentences > 0 ? ((methodStats.no_attribution || 0) / totalSentences * 100).toFixed(1) : 0}%)</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateChunkSummary(chunks) {
            if (!chunks?.chunk_details) return '';
            
            return `
                <div class="chunk-summary">
                    <h3>📄 Available Chunks</h3>
                    <div class="chunk-list">
                        ${chunks.chunk_details.map(chunk => `
                            <div class="chunk-item">
                                <div class="chunk-id">Chunk ${chunk.chunk_id}</div>
                                <div class="chunk-doc">From: ${chunk.document_name}</div>
                                <div style="margin-top: 8px; font-size: 0.85em; color: #666;">
                                    ${chunk.chunk_text.substring(0, 100)}...
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function generateFiscalNoteSections() {
            const sections = [
                'overview', 'appropriations', 'assumptions_and_methodology', 'agency_impact',
                'economic_impact', 'policy_impact', 'revenue_sources', 'six_year_fiscal_implications',
                'operating_revenue_impact', 'capital_expenditure_impact', 'fiscal_implications_after_6_years',
                'updates_from_previous_fiscal_note'
            ];

            return sections.map(section => {
                const content = fiscalNoteData[section];
                if (!content) return '';

                const processedContent = processContentWithSentenceAttribution(content, section);
                const sectionAttributions = getSectionAttributions(content);

                return `
                    <div class="fiscal-section">
                        <h2 class="section-title">${section.replace(/_/g, ' ')}</h2>
                        <div class="section-content">${processedContent}</div>
                        ${sectionAttributions.length > 0 ? generateSectionAttributionSummary(sectionAttributions) : ''}
                    </div>
                `;
            }).join('');
        }

        function processContentWithSentenceAttribution(content, sectionName) {
            const attribution = metadataData.response_metadata?.sentence_attribution_analysis;
            if (!attribution?.sentence_attributions) return content;

            let processedContent = content;
            
            // Create a map of clean sentences to their attribution data
            const sentenceMap = new Map();
            
            attribution.sentence_attributions.forEach((sentAttr, index) => {
                if (sentAttr.sentence && sentAttr.attributed_chunk_id !== null) {
                    let cleanSentence = sentAttr.sentence;
                    
                    // Remove JSON structure - handle multiple patterns
                    // Pattern: "field": "content" or {"field": "content"
                    const jsonStartMatch = cleanSentence.match(/(?:^[^"]*)?\"[^"]*\":\s*\"(.*)$/);
                    if (jsonStartMatch) {
                        cleanSentence = jsonStartMatch[1];
                    }
                    
                    // Remove JSON end structure: content",\n"nextfield":
                    const jsonEndMatch = cleanSentence.match(/^(.*?)\"(?:\s*,\s*\n?\s*\"[^"]*\":|$)/);
                    if (jsonEndMatch) {
                        cleanSentence = jsonEndMatch[1];
                    }
                    
                    // Clean up quotes and whitespace, handle escaped quotes
                    cleanSentence = cleanSentence.replace(/^"+|"+$/g, '').trim();
                    // Convert escaped quotes to regular quotes
                    cleanSentence = cleanSentence.replace(/\\"/g, '"');
                    
                    // Store the best attribution for this sentence (prefer higher scores)
                    if (!sentenceMap.has(cleanSentence) || sentAttr.attribution_score > sentenceMap.get(cleanSentence).attribution_score) {
                        sentenceMap.set(cleanSentence, sentAttr);
                    }
                }
            });
            
            // Apply citations to sentences found in content
            sentenceMap.forEach((sentAttr, cleanSentence) => {
                // Use a more flexible matching approach
                const sentenceRegex = new RegExp(cleanSentence.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                
                if (processedContent.includes(cleanSentence)) {
                    const chunkId = sentAttr.attributed_chunk_id;
                    const method = sentAttr.attribution_method;
                    const score = sentAttr.attribution_score;
                    const reason = sentAttr.attribution_reason;
                    
                    // Get chunk info for tooltip
                    let chunkInfo = null;
                    if (chunkId && chunkId.toString().startsWith('NUMBER_')) {
                        // Try direct lookup first
                        chunkInfo = numbersMap.get(chunkId);
                        
                        // If not found, try alternative formats
                        if (!chunkInfo) {
                            const numberPart = chunkId.replace('NUMBER_', '');
                            const alternativeFormats = [
                                `NUMBER_${numberPart}`,
                                `NUMBER_${parseFloat(numberPart)}`,
                                `NUMBER_${Math.floor(parseFloat(numberPart))}`,
                                `NUMBER_${Math.floor(parseFloat(numberPart))}.0`
                            ];
                            
                            for (const format of alternativeFormats) {
                                chunkInfo = numbersMap.get(format);
                                if (chunkInfo) {
                                    console.log(`Found ${chunkId} using alternative format: ${format}`);
                                    break;
                                }
                            }
                        }
                        
                        if (!chunkInfo) {
                            console.log(`Looking up ${chunkId}: Not found`);
                            console.log(`Available NUMBER_ keys:`, Array.from(numbersMap.keys()).filter(k => k.startsWith('NUMBER_')));
                            
                            // Fallback: create a minimal entry from the attribution data
                            const numberPart = chunkId.replace('NUMBER_', '');
                            chunkInfo = {
                                chunk_id: chunkId,
                                document_name: 'Unknown Document',
                                chunk_text: `Financial amount: $${numberPart} (source document not available)`,
                                number: parseFloat(numberPart) || 0
                            };
                            console.log(`Created fallback entry for ${chunkId}`);
                        }
                    } else {
                        chunkInfo = chunkMap.get(chunkId);
                    }
                    
                    const displayChunkId = chunkId && chunkId.toString().startsWith('NUMBER_') ? 
                        chunkId.replace('NUMBER_', 'N') : 
                        chunkId;
                    
                    // Create citation with proper escaping and better error handling
                    const chunkText = chunkInfo?.chunk_text ? 
                        chunkInfo.chunk_text.replace(/"/g, '&quot;').substring(0, 500) : 
                        'Content not available';
                    const documentName = chunkInfo?.document_name ? 
                        chunkInfo.document_name.replace(/"/g, '&quot;') : 
                        'Unknown';
                    const escapedReason = reason.replace(/"/g, '&quot;');
                    
                    const citation = `<span class="citation-number" 
                                           data-chunk-id="${chunkId}"
                                           data-method="${method}"
                                           data-score="${score}"
                                           data-reason="${escapedReason}"
                                           data-chunk-text="${chunkText}"
                                           data-document="${documentName}"
                                           title="Click for details">[${displayChunkId}]</span>`;
                    
                    // Replace only if not already processed
                    if (!processedContent.includes(cleanSentence + '<span class="citation-number"')) {
                        processedContent = processedContent.replace(cleanSentence, cleanSentence + citation);
                    }
                }
            });
            
            return processedContent;
        }

        function getSectionAttributions(content) {
            const attribution = metadataData.response_metadata?.sentence_attribution_analysis;
            if (!attribution?.sentence_attributions) return [];

            // Find attributions for sentences in this section
            return attribution.sentence_attributions.filter(sentAttr => 
                sentAttr.sentence && content.includes(sentAttr.sentence)
            );
        }

        function generateSectionAttributionSummary(sectionAttributions) {
            const chunkUsage = {};
            
            sectionAttributions.forEach(attr => {
                if (attr.attributed_chunk_id !== null) {
                    if (!chunkUsage[attr.attributed_chunk_id]) {
                        // Look up chunk in both regular chunks and numbers map
                        let chunk = null;
                        if (attr.attributed_chunk_id && attr.attributed_chunk_id.toString().startsWith('NUMBER_')) {
                            chunk = numbersMap.get(attr.attributed_chunk_id);
                        } else {
                            chunk = chunkMap.get(attr.attributed_chunk_id);
                        }
                        
                        chunkUsage[attr.attributed_chunk_id] = {
                            count: 0,
                            document_name: chunk?.document_name || 'Unknown',
                            chunk_text: chunk?.chunk_text || 'Chunk not available',
                            methods: new Set()
                        };
                    }
                    chunkUsage[attr.attributed_chunk_id].count++;
                    chunkUsage[attr.attributed_chunk_id].methods.add(attr.attribution_method);
                }
            });

            return `
                <div class="section-attribution-summary">
                    <h4 class="attribution-title">📚 Source Attribution Summary</h4>
                    <div class="attribution-stats">
                        <span class="stat">📝 ${sectionAttributions.length} sentences</span>
                        <span class="stat">🔢 ${sectionAttributions.filter(a => a.attribution_method === 'number_based').length} number-based</span>
                        <span class="stat">📊 ${sectionAttributions.filter(a => a.attribution_method === 'word_frequency_based').length} word-frequency</span>
                        <span class="stat">📄 ${Object.keys(chunkUsage).length} chunks used</span>
                    </div>
                    <div class="chunks-grid">
                        ${Object.entries(chunkUsage).map(([chunkId, usage]) => {
                            const displayChunkId = chunkId.toString().startsWith('NUMBER_') ? 
                                `Number ${chunkId.replace('NUMBER_', '')}` : 
                                `Chunk ${chunkId}`;
                            
                            return `
                                <div class="chunk-reference">
                                    <div class="chunk-ref-header">
                                        <span class="chunk-ref-id">${displayChunkId}</span>
                                        <span class="chunk-ref-doc">📄 ${usage.document_name}</span>
                                        <span class="chunk-usage-count">${usage.count} sentences</span>
                                    </div>
                                    <div class="chunk-methods">
                                        ${Array.from(usage.methods).map(method => 
                                            `<span class="method-tag ${method}">${method.replace('_', ' ')}</span>`
                                        ).join('')}
                                    </div>
                                    <div class="chunk-ref-content">
                                        ${usage.chunk_text}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function processContentWithCitations(content) {
            // Replace [CHUNK:X] and [CHUNK:X:$amount] with interactive elements
            return content.replace(/\[CHUNK:(\d+)(?::(\$[\d,]+))?\]/g, (match, chunkId, amount) => {
                const chunk = chunkMap.get(parseInt(chunkId));
                const hasAmount = amount ? 'with-amount' : '';
                
                return `<span class="chunk-citation ${hasAmount}" 
                              data-chunk-id="${chunkId}" 
                              data-amount="${amount || ''}"
                              data-document="${chunk?.document_name || 'Unknown'}"
                              data-content="${chunk?.chunk_text || 'Chunk not found'}">${match}</span>`;
            });
        }

        function addCitationListeners() {
            // Remove existing tooltips
            document.querySelectorAll('.citation-tooltip').forEach(tooltip => tooltip.remove());
            
            const citations = document.querySelectorAll('.citation-number');
            console.log(`Adding citation listeners to ${citations.length} citations`);
            
            citations.forEach(citation => {
                // Remove existing listeners
                citation.removeEventListener('mouseenter', showCitationTooltip);
                citation.removeEventListener('mouseleave', hideCitationTooltip);
                citation.removeEventListener('click', showCitationDetails);
                
                // Add new listeners
                citation.addEventListener('mouseenter', showCitationTooltip);
                citation.addEventListener('mouseleave', hideCitationTooltip);
                citation.addEventListener('click', showCitationDetails);
            });
        }

        function showCitationTooltip(event) {
            const citation = event.target;
            const chunkId = citation.dataset.chunkId;
            const method = citation.dataset.method;
            const reason = citation.dataset.reason;
            const chunkText = citation.dataset.chunkText;
            const document = citation.dataset.document;

            // Remove any existing tooltips
            const existingTooltips = document.querySelectorAll('.citation-tooltip');
            existingTooltips.forEach(tooltip => tooltip.remove());

            const tooltip = document.createElement('div');
            tooltip.className = 'citation-tooltip';
            
            const displayChunkId = chunkId && chunkId.toString().startsWith('NUMBER_') ? 
                `Number ${chunkId.replace('NUMBER_', '')}` : 
                `Chunk ${chunkId}`;
            
            tooltip.innerHTML = `
                <div class="citation-tooltip-header">${displayChunkId}</div>
                <div class="citation-tooltip-method">Method: ${method.replace('_', ' ')}</div>
                <div style="color: #81C784;">Document: ${document}</div>
                <div style="color: #FFB74D; margin: 4px 0;">Reason: ${reason}</div>
                <div class="citation-tooltip-content">${chunkText.substring(0, 200)}...</div>
            `;

            document.body.appendChild(tooltip);

            // Position tooltip
            const rect = citation.getBoundingClientRect();
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            
            tooltip.style.left = (rect.left + scrollLeft) + 'px';
            tooltip.style.top = (rect.bottom + scrollTop + 5) + 'px';
            tooltip.style.display = 'block';

            // Store reference for cleanup
            citation._tooltip = tooltip;
        }

        function hideCitationTooltip(event) {
            const citation = event.target;
            if (citation._tooltip) {
                citation._tooltip.remove();
                citation._tooltip = null;
            }
        }

        function showCitationDetails(event) {
            event.preventDefault();
            const citation = event.target;
            const chunkId = citation.dataset.chunkId;
            const method = citation.dataset.method;
            const score = citation.dataset.score;
            const reason = citation.dataset.reason;
            const chunkText = citation.dataset.chunkText;
            const document = citation.dataset.document;
            
            const displayChunkId = chunkId && chunkId.toString().startsWith('NUMBER_') ? 
                `Number ${chunkId.replace('NUMBER_', '')}` : 
                `Chunk ${chunkId}`;

            alert(`Citation Details:\\n\\n${displayChunkId}\\nMethod: ${method}\\nScore: ${score}\\nReason: ${reason}\\nDocument: ${document}\\n\\nContent:\\n${chunkText.substring(0, 500)}...`);
        }

        function showSentenceDetails(event) {
            event.preventDefault();
            const sentence = event.target;
            const chunkId = sentence.dataset.chunkId;
            const method = sentence.dataset.method;
            const score = sentence.dataset.score;
            const reason = sentence.dataset.reason;
            
            // Look up chunk in both regular chunks and numbers map
            let chunk = null;
            if (chunkId && chunkId.startsWith('NUMBER_')) {
                chunk = numbersMap.get(chunkId);
            } else {
                chunk = chunkMap.get(parseInt(chunkId));
            }
            
            const chunkText = chunk ? chunk.chunk_text : 'Chunk not available';
            const docName = chunk ? chunk.document_name : 'Unknown';
            const displayChunkId = chunkId && chunkId.startsWith('NUMBER_') ? 
                `Number ${chunkId.replace('NUMBER_', '')}` : 
                `Chunk ${chunkId}`;

            alert(`Attribution Details:\\n\\nMethod: ${method}\\nScore: ${score}\\nReason: ${reason}\\n\\nSource ${displayChunkId} (${docName}):\\n${chunkText.substring(0, 300)}...`);
        }

        function showSentenceTooltip(event) {
            const sentence = event.target;
            const chunkId = sentence.dataset.chunkId;
            const method = sentence.dataset.method;
            const reason = sentence.dataset.reason;
            
            // Look up chunk in both regular chunks and numbers map
            let chunk = null;
            if (chunkId && chunkId.startsWith('NUMBER_')) {
                chunk = numbersMap.get(chunkId);
            } else {
                chunk = chunkMap.get(parseInt(chunkId));
            }

            // Remove any existing tooltips
            document.querySelectorAll('.tooltip').forEach(tooltip => tooltip.remove());

            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            
            const displayChunkId = chunkId && chunkId.startsWith('NUMBER_') ? 
                `Number ${chunkId.replace('NUMBER_', '')}` : 
                `Chunk ${chunkId}`;
            
            tooltip.innerHTML = `
                <div class="tooltip-header">Sentence Attribution</div>
                <div class="tooltip-method">🔍 Method: ${method.replace('_', ' ')}</div>
                <div class="tooltip-chunk">📄 ${displayChunkId} (${chunk?.document_name || 'Unknown'})</div>
                <div class="tooltip-reason">💡 ${reason}</div>
                <div class="tooltip-content">"${chunk?.chunk_text?.substring(0, 150) || 'Content not available'}..."</div>
            `;

            document.body.appendChild(tooltip);

            // Position tooltip
            const rect = sentence.getBoundingClientRect();
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            
            tooltip.style.left = (rect.left + scrollLeft) + 'px';
            tooltip.style.top = (rect.bottom + scrollTop + 10) + 'px';
            tooltip.style.display = 'block';

            // Store reference for cleanup
            sentence._tooltip = tooltip;
        }

        function hideSentenceTooltip(event) {
            const sentence = event.target;
            if (sentence._tooltip) {
                sentence._tooltip.remove();
                sentence._tooltip = null;
            }
        }

        function showTooltipOnClick(event) {
            event.preventDefault();
            const citation = event.target;
            const chunkId = citation.dataset.chunkId;
            const amount = citation.dataset.amount;
            const document = citation.dataset.document;
            const content = citation.dataset.content;

            alert(`Chunk ${chunkId}\\nDocument: ${document}\\n${amount ? `Amount: ${amount}\\n` : ''}Content: ${content.substring(0, 200)}...`);
        }

        function showTooltip(event) {
            const citation = event.target;
            const chunkId = citation.dataset.chunkId;
            const amount = citation.dataset.amount;
            const document = citation.dataset.document;
            const content = citation.dataset.content;

            // Remove any existing tooltips
            document.querySelectorAll('.tooltip').forEach(tooltip => tooltip.remove());

            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.innerHTML = `
                <div class="tooltip-header">Chunk ${chunkId}</div>
                <div class="tooltip-document">📄 ${document}</div>
                ${amount ? `<div class="tooltip-amount">💰 ${amount}</div>` : ''}
                <div class="tooltip-content">"${content ? content.substring(0, 200) + '...' : 'Content not available'}"</div>
            `;

            document.body.appendChild(tooltip);

            // Position tooltip
            const rect = citation.getBoundingClientRect();
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            
            tooltip.style.left = (rect.left + scrollLeft) + 'px';
            tooltip.style.top = (rect.bottom + scrollTop + 10) + 'px';
            tooltip.style.display = 'block';

            // Store reference for cleanup
            citation._tooltip = tooltip;
        }

        function hideTooltip(event) {
            const citation = event.target;
            if (citation._tooltip) {
                citation._tooltip.remove();
                citation._tooltip = null;
            }
        }

        function showError(message) {
            const container = document.getElementById('fiscalNoteContainer');
            container.style.display = 'block';
            container.innerHTML = `<div class="error">${message}</div>`;
        }
    </script>
</body>
</html>
