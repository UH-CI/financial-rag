<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiscal Note Citation Metadata Viewer</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .file-selector {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .file-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }
        
        .file-selector input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 6px;
            background: #fafafa;
        }
        
        .metadata-container {
            display: none;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .overview-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .document-ref {
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 6px 6px 0;
        }
        
        .document-name {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }
        
        .mention-count {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .text-sample {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
            font-style: italic;
            background: white;
            padding: 10px;
            border-radius: 4px;
        }
        
        .number-ref {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 6px 6px 0;
        }
        
        .number-amount {
            font-weight: bold;
            color: #f57c00;
            font-size: 1.2em;
        }
        
        .number-source {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .citation-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }
        
        .citation-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.85em;
            border: 1px solid #bbdefb;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #f44336;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
        
        .fiscal-note-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .section-title {
            color: #333;
            margin: 0;
            font-size: 1.3em;
            text-transform: capitalize;
        }
        
        .section-stats {
            display: flex;
            gap: 10px;
        }
        
        .section-stat {
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            color: #666;
        }
        
        .section-content {
            line-height: 1.6;
            color: #444;
        }
        
        .highlighted-citation {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px solid #ffc107;
            cursor: pointer;
            position: relative;
        }
        
        .highlighted-number {
            background: #d4edda;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px solid #28a745;
            font-weight: bold;
            cursor: pointer;
        }
        
        .tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.8em;
            z-index: 1000;
            max-width: 300px;
            display: none;
        }
        
        .section-attribution {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #6c757d;
        }
        
        .attribution-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>📊 Fiscal Note Citation Metadata Viewer</h1>
        <p>Analyze document attribution and citation patterns in generated fiscal notes</p>
    </div>

    <div class="file-selector">
        <label for="fileInput">Select a metadata JSON file:</label>
        <input type="file" id="fileInput" accept=".json" />
    </div>

    <div id="metadataContainer" class="metadata-container">
        <!-- Content will be populated by JavaScript -->
    </div>

    <script>
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const metadata = JSON.parse(e.target.result);
                        displayMetadata(metadata);
                    } catch (error) {
                        showError('Invalid JSON file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        function displayMetadata(metadata) {
            const container = document.getElementById('metadataContainer');
            container.style.display = 'block';
            
            const attribution = metadata.response_metadata?.custom_attribution_analysis;
            const usage = metadata.response_metadata?.usage_metadata;
            
            if (!attribution) {
                container.innerHTML = '<div class="no-data">No attribution analysis found in this metadata file.</div>';
                return;
            }

            container.innerHTML = `
                <div class="overview-stats">
                    <div class="stat-card">
                        <span class="stat-number">${metadata.numbers_used || 0}</span>
                        <span class="stat-label">Numbers Used</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${attribution.document_references?.length || 0}</span>
                        <span class="stat-label">Documents Referenced</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${attribution.text_analysis?.citation_count || 0}</span>
                        <span class="stat-label">Total Citations</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${usage?.total_token_count || 'N/A'}</span>
                        <span class="stat-label">Total Tokens</span>
                    </div>
                </div>

                <div class="card">
                    <h2>📄 Document References</h2>
                    ${generateDocumentReferences(attribution.document_references)}
                </div>

                <div class="card">
                    <h2>💰 Number References</h2>
                    ${generateNumberReferences(attribution.number_references)}
                </div>

                <div class="card">
                    <h2>🔗 Citation Analysis</h2>
                    ${generateCitationAnalysis(attribution.text_analysis)}
                </div>

                <div class="card">
                    <h2>⚙️ Generation Details</h2>
                    ${generateGenerationDetails(metadata)}
                </div>
            `;
        }

        function generateDocumentReferences(docRefs) {
            if (!docRefs || docRefs.length === 0) {
                return '<div class="no-data">No document references found.</div>';
            }

            return docRefs.map(ref => `
                <div class="document-ref">
                    <div class="document-name">
                        ${ref.document_name}
                        <span class="mention-count">${ref.mention_count} mentions</span>
                    </div>
                    <div class="text-sample">${ref.text_sample}</div>
                </div>
            `).join('');
        }

        function generateNumberReferences(numRefs) {
            if (!numRefs || numRefs.length === 0) {
                return '<div class="no-data">No number references found.</div>';
            }

            return numRefs.map(ref => `
                <div class="number-ref">
                    <div class="number-amount">$${ref.number.toLocaleString()}</div>
                    <div class="number-source">
                        Source: ${ref.filename} (${ref.document_type})
                    </div>
                    <div class="text-sample">${ref.context_sample}</div>
                </div>
            `).join('');
        }

        function generateCitationAnalysis(textAnalysis) {
            if (!textAnalysis) {
                return '<div class="no-data">No citation analysis available.</div>';
            }

            return `
                <p><strong>Response Length:</strong> ${textAnalysis.total_length.toLocaleString()} characters</p>
                <p><strong>Citations Found:</strong> ${textAnalysis.citation_count}</p>
                <div class="citation-list">
                    ${textAnalysis.citations_found?.map(citation => 
                        `<span class="citation-tag">${citation}</span>`
                    ).join('') || '<span class="no-data">No citations to display</span>'}
                </div>
            `;
        }

        function generateGenerationDetails(metadata) {
            const usage = metadata.response_metadata?.usage_metadata;
            return `
                <p><strong>Document:</strong> ${metadata.document_name}</p>
                <p><strong>Generated:</strong> ${new Date(metadata.generation_timestamp).toLocaleString()}</p>
                <p><strong>Processed Documents:</strong> ${metadata.processed_documents?.join(', ') || 'N/A'}</p>
                <p><strong>Prompt Length:</strong> ${metadata.prompt_length?.toLocaleString()} characters</p>
                ${usage ? `
                    <p><strong>Token Usage:</strong></p>
                    <ul>
                        <li>Prompt: ${usage.prompt_token_count?.toLocaleString()} tokens</li>
                        <li>Response: ${usage.candidates_token_count?.toLocaleString()} tokens</li>
                        <li>Total: ${usage.total_token_count?.toLocaleString()} tokens</li>
                    </ul>
                ` : ''}
            `;
        }

        function showError(message) {
            const container = document.getElementById('metadataContainer');
            container.style.display = 'block';
            container.innerHTML = `<div class="error">${message}</div>`;
        }
    </script>
</body>
</html>
