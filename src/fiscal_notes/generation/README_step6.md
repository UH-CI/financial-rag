# Step 6: Add Chunk References to Fiscal Notes

## Overview

Step 6 enhances fiscal notes generated by Step 5 by adding chunk-level references with cosine similarity matching. This provides more granular source attribution for each citation in the fiscal notes.

## What It Does

1. **Document Splitting**: Splits documents from Step 3 into individual sentences for precise matching
2. **Reference Extraction**: Identifies sentences in fiscal notes that contain document references
3. **Similarity Matching**: Uses AllMiniLM embeddings and cosine similarity to find the most relevant chunk for each reference
4. **Enhancement**: Adds chunk information to fiscal note data structure

## Prerequisites

- **Step 3 completed**: Document retrieval with text files in `documents/` directory
- **Step 5 completed**: Fiscal notes generated in `fiscal_notes/` directory
- **Python packages**: `nltk`, `scikit-learn`, `numpy`, `sentence-transformers`

## Installation

```bash
pip install nltk scikit-learn numpy sentence-transformers
```

## Usage

### Command Line

```bash
python step6_add_chunk_references.py <fiscal_notes_dir> <documents_dir>
```

Example:
```bash
python step6_add_chunk_references.py ./fiscal_notes ./documents
```

### Programmatic Usage

```python
from step6_add_chunk_references import add_chunk_references_to_fiscal_notes

enhanced_dir = add_chunk_references_to_fiscal_notes(
    fiscal_notes_dir="./fiscal_notes",
    documents_dir="./documents"
)
```

## Input Structure

### Fiscal Notes Directory
```
fiscal_notes/
├── HB1234_2025_fiscal_note_1.json
├── HB1234_2025_fiscal_note_2.json
└── ...
```

### Documents Directory
```
documents/
├── HB1234.txt
├── HB1234_TESTIMONY_JHA_02-06-25_.txt
├── HB1234_HD1.txt
└── ...
```

## Output Structure

### Enhanced Fiscal Notes Directory
```
fiscal_notes_with_chunks/
├── HB1234_2025_fiscal_note_1.json  # Enhanced with chunk references
├── HB1234_2025_fiscal_note_2.json  # Enhanced with chunk references
└── ...
```

### Enhanced Data Structure

Original fiscal note:
```json
{
  "economic_impact": "The bill will impact businesses (HB1234_TESTIMONY_JHA_02-06-25_)."
}
```

Enhanced fiscal note:
```json
{
  "economic_impact": "The bill will impact businesses (HB1234_TESTIMONY_JHA_02-06-25_).",
  "economic_impact_chunk_references": [
    {
      "sentence": {
        "sentence_id": 0,
        "text": "The bill will impact businesses (HB1234_TESTIMONY_JHA_02-06-25_).",
        "references": ["HB1234_TESTIMONY_JHA_02-06-25_"],
        "clean_text": "The bill will impact businesses."
      },
      "chunk_matches": {
        "HB1234_TESTIMONY_JHA_02-06-25_": {
          "document_name": "HB1234_TESTIMONY_JHA_02-06-25_",
          "chunk": {
            "id": 15,
            "text": "small businesses will face significant compliance costs...",
            "start_token": 1500,
            "end_token": 1600,
            "token_count": 100,
            "similarity_score": 0.847
          }
        }
      }
    }
  ]
}
```

## API Integration

The enhanced fiscal notes are automatically processed by the API to include chunk information in document references:

### Backend Processing
- `process_fiscal_note_references_structured()` now includes chunk data
- Reference format: `number|url|type|name|description|chunk_text|similarity_score`

### Frontend Display
- Citations show chunk preview in tooltips
- Similarity scores indicate reference quality
- Enhanced tooltips with source text context

## Features

### Sentence-Based Matching
- **Granularity**: Individual sentences for maximum precision
- **No Overlap**: Each sentence is a discrete unit
- **Filtering**: Skips very short sentences (< 10 characters)
- **Method**: Direct sentence-to-sentence similarity matching

### Similarity Matching
- **Algorithm**: AllMiniLM Embeddings + Cosine Similarity
- **Model**: `all-MiniLM-L6-v2` (384-dimensional embeddings)
- **Advantages**: Semantic understanding beyond keyword matching
- **Performance**: Better context-aware similarity scoring

### Quality Indicators
- **Similarity Score**: 0.0 to 1.0 (higher = better match)
- **Token Count**: Number of tokens in matched chunk
- **Chunk Position**: Start/end token positions in document

## Example Workflow

```bash
# Step 1-2: Bill analysis and document extraction (previous steps)
# Step 3: Document retrieval
python step3_retrieve_docs.py

# Step 4: Document processing (if needed)
# Step 5: Fiscal note generation
python step5_fiscal_note_gen.py

# Step 6: Add chunk references
python step6_add_chunk_references.py ./fiscal_notes ./documents

# Result: Enhanced fiscal notes with chunk-level source attribution
```

## Performance Considerations

- **Memory Usage**: Proportional to document size and number of chunks
- **Processing Time**: ~1-5 seconds per fiscal note depending on document count
- **Chunk Limit**: Chunk text truncated to 200 characters for API efficiency

## Error Handling

- **Missing Documents**: Logs warnings for unfound document references
- **Similarity Failures**: Falls back to first chunk if similarity calculation fails
- **Invalid References**: Skips malformed or unmatched references

## Integration with Frontend

Enhanced references appear in the fiscal note viewer with:
- **Rich Tooltips**: Show source chunk text and similarity score
- **Quality Indicators**: Visual indication of reference strength
- **Source Context**: Preview of actual referenced content

This provides users with transparency about the source and quality of each citation in the fiscal notes.
